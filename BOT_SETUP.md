# Настройка бота МАКС для системы управления учебниками

## 1. Создание бота

### Шаг 1: Получение токена
1. Откройте МАКС мессенджер
2. Найдите и откройте диалог с **Master Bot**
3. Следуйте инструкциям для создания нового бота
4. После создания бота Master Bot отправит вам токен

### Шаг 2: Настройка переменных окружения
Создайте файл `.env` в корне проекта и добавьте:

```env
# Токен бота МАКС
MAX_BOT_TOKEN=your_bot_token_here

# ID чата учителя (опционально, для уведомлений)
TEACHER_CHAT_ID=your_chat_id_here
```

## 2. Настройка команд бота

### Основные команды для учеников:
- `/start` - Приветствие и инструкции
- `/my_textbooks` - Показать мои учебники
- `/report_damage` - Сообщить о повреждении
- `/report_lost` - Сообщить об утере
- `/report_found` - Сообщить о находке
- `/damage_reminder` - Напоминание о проверке повреждений

### Команды для учителя:
- `/reports` - Получить отчеты
- `/notifications` - Управление уведомлениями
- `/bulk_issue` - Массовая выдача учебников
- `/bulk_return` - Массовый возврат учебников

## 3. Тестирование подключения

После настройки токена протестируйте подключение:

```bash
curl -X GET "http://localhost:8000/api/bot/test-connection" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"
```

## 4. Настройка вебхуков (для получения обновлений)

### Вариант 1: Использование ngrok (для разработки)
1. Установите ngrok: https://ngrok.com/
2. Запустите туннель:
```bash
ngrok http 8000
```
3. Скопируйте HTTPS URL (например: `https://abc123.ngrok.io`)
4. Настройте вебхук в API МАКС

### Вариант 2: Использование реального домена
1. Настройте домен с SSL сертификатом
2. Укажите URL для вебхуков: `https://yourdomain.com/api/bot/webhook`

## 5. API эндпоинты для бота

### Управление ботом:
- `GET /api/bot/info` - Информация о боте
- `PATCH /api/bot/info` - Обновление информации о боте
- `GET /api/bot/test-connection` - Тест подключения

### Отправка сообщений:
- `POST /api/bot/send-message` - Отправить сообщение в чат
- `POST /api/bot/send-to-user` - Отправить сообщение пользователю

### Управление чатами:
- `GET /api/bot/chat/{chat_id}` - Информация о чате
- `GET /api/bot/chat/{chat_id}/members` - Участники чата
- `POST /api/bot/chat/{chat_id}/members` - Добавить участника
- `DELETE /api/bot/chat/{chat_id}/members/{user_id}` - Удалить участника

### Управление сообщениями:
- `GET /api/bot/chat/{chat_id}/messages` - Получить сообщения
- `PUT /api/bot/message/{message_id}` - Редактировать сообщение
- `DELETE /api/bot/message/{message_id}` - Удалить сообщение

## 6. Интеграция с системой

### Автоматические уведомления:
1. **При выдаче учебников** - уведомление родителей
2. **При возврате учебников** - уведомление родителей
3. **При утере учебника** - уведомление учителя и родителей
4. **При находке учебника** - уведомление учителя и владельца
5. **Напоминания о проверке** - уведомление учеников и родителей

### Ручные уведомления:
- Массовые уведомления по классам
- Напоминания о возврате учебников
- Отчеты о состоянии учебников

## 7. Безопасность

### Рекомендации:
1. Храните токен бота в безопасном месте
2. Используйте HTTPS для вебхуков
3. Ограничьте доступ к API только авторизованным пользователям
4. Логируйте все действия бота
5. Регулярно обновляйте токен бота

### Переменные окружения:
```env
# Обязательные
MAX_BOT_TOKEN=your_bot_token

# Опциональные
TEACHER_CHAT_ID=teacher_chat_id
BOT_WEBHOOK_SECRET=webhook_secret
LOG_LEVEL=INFO
```

## 8. Мониторинг и логирование

### Логи бота:
- Все входящие сообщения
- Все исходящие уведомления
- Ошибки подключения к API
- Статистика использования

### Метрики:
- Количество активных пользователей
- Количество отправленных уведомлений
- Время отклика API
- Частота ошибок

## 9. Примеры использования

### Отправка уведомления о выдаче учебников:
```python
from app.services.max_bot_client import MaxBotClient

async def notify_issue():
    bot = MaxBotClient()
    await bot.send_parent_notification(
        parent_phone="+79001234567",
        student_name="Иванов Иван",
        message_type="issue",
        total_count=5,
        textbook_list="• Математика: Алгебра 7 класс\n• Русский язык: Грамматика 7 класс"
    )
    await bot.close()
```

### Получение информации о боте:
```python
from app.services.max_bot_client import MaxBotClient

async def get_bot_info():
    bot = MaxBotClient()
    info = await bot.get_bot_info()
    await bot.close()
    return info
```

## 10. Устранение неполадок

### Частые проблемы:

1. **Ошибка "Bot token is required"**
   - Проверьте переменную окружения `MAX_BOT_TOKEN`
   - Убедитесь, что файл `.env` загружается

2. **Ошибка подключения к API**
   - Проверьте интернет-соединение
   - Убедитесь, что токен бота действителен
   - Проверьте статус API МАКС

3. **Сообщения не отправляются**
   - Проверьте права бота
   - Убедитесь, что пользователь не заблокировал бота
   - Проверьте формат сообщения

4. **Вебхуки не работают**
   - Проверьте URL вебхука
   - Убедитесь, что используется HTTPS
   - Проверьте настройки файрвола

### Полезные команды для отладки:
```bash
# Тест подключения
curl -X GET "http://localhost:8000/api/bot/test-connection"

# Получение информации о боте
curl -X GET "http://localhost:8000/api/bot/info" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN"

# Отправка тестового сообщения
curl -X POST "http://localhost:8000/api/bot/send-message" \
  -H "Authorization: Bearer YOUR_JWT_TOKEN" \
  -F "chat_id=CHAT_ID" \
  -F "text=Тестовое сообщение" \
  -F "format_type=markdown"
``` 